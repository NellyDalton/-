<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç­ä½œä¸šæ‰«æç‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        /* é¡¶éƒ¨æ ï¼šæ˜¾ç¤ºçŠ¶æ€ + å¯¼å‡ºæŒ‰é’® */
        .header { 
            height: 54px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 20;
        }
        .stats { font-size: 12px; color: #aaa; line-height: 1.3; }
        .stats b { color: #fff; font-size: 14px; margin-right: 2px; }
        
        /* å¯¼å‡ºæŒ‰é’® */
        .btn-export {
            background: #10b981; color: white; border: none; padding: 6px 14px; 
            border-radius: 20px; font-weight: bold; font-size: 13px;
            box-shadow: 0 2px 8px rgba(16,185,129,0.3);
            display: flex; align-items: center; gap: 4px; transition: 0.2s;
        }
        .btn-export:active { transform: scale(0.95); opacity: 0.9; }
        .btn-export:disabled { background: #333; color: #666; box-shadow: none; }

        /* æ‘„åƒå¤´åŒºåŸŸ */
        #cam-container { flex: 1; position: relative; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æµ®åŠ¨æç¤ºï¼šå½“å‰æ­£åœ¨æ‹è° */
        .current-hud {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(56, 189, 248, 0.25); border: 1px solid rgba(56, 189, 248, 0.4);
            backdrop-filter: blur(4px); color: #e0f2fe; 
            padding: 6px 16px; border-radius: 20px;
            font-size: 14px; font-weight: bold; pointer-events: none; z-index: 10;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        .controls { 
            height: 160px; background: #080808; border-top: 1px solid #222;
            display: grid; grid-template-columns: 1fr auto 1fr; 
            align-items: center; padding: 0 20px; gap: 10px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* æŒ‰é’®é€šç”¨ */
        button { outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* æ‹ç…§å¤§æŒ‰é’® */
        .shutter-ring {
            width: 72px; height: 72px; border-radius: 50%; border: 3px solid #fff;
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
        }
        .shutter-inner {
            width: 60px; height: 60px; background: #fff; border-radius: 50%;
            transition: transform 0.1s;
        }
        .shutter-inner:active { transform: scale(0.9); background: #ccc; }

        /* ä¾§è¾¹åŠŸèƒ½é”® */
        .side-btn {
            background: transparent; border: none; color: #fff; 
            display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 12px;
        }
        .icon-circle {
            width: 46px; height: 46px; border-radius: 50%; background: #222;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            transition: background 0.2s;
        }
        .side-btn:active .icon-circle { background: #333; }
        
        /* ä¸‹ä¸€ä½æŒ‰é’®é«˜äº® */
        .btn-next .icon-circle { background: #2563eb; color: #fff; }
        .btn-next:active .icon-circle { background: #1d4ed8; }

        /* é¢„è§ˆç¼©ç•¥å›¾ */
        .preview-box {
            position: absolute; bottom: 20px; right: 20px; 
            width: 64px; height: 86px; background: #222; border: 2px solid #fff; 
            border-radius: 6px; overflow: hidden; display: none; z-index: 15;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .page-badge { 
            position: absolute; bottom: 0; left:0; width: 100%; 
            background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; 
            text-align: center; padding: 2px 0; 
        }

        .flash { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; transition: opacity 0.15s; z-index: 30; }

        /* åŠ è½½é®ç½© */
        #loading {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner { width: 36px; height: 36px; border: 4px solid #333; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <div class="stats">
        å·²å­˜åº“: <b id="totalSaved">0</b> äºº<br>
        <span style="opacity:0.6">å†…å­˜å ç”¨ â‰ˆ <span id="memUsage">0</span> MB</span>
    </div>
    <button class="btn-export" id="btnExport" onclick="exportAll()" disabled>
        <span>ğŸ“¦ æ‰“åŒ…å…¨ç­</span>
    </button>
</div>

<div id="cam-container">
    <video id="video" autoplay playsinline></video>
    <div class="current-hud">å½“å‰: å­¦ç”Ÿ <span id="currId" style="font-size:1.3em; color:#fff">1</span> (ç¬¬ <span id="currPage">0</span> é¡µ)</div>
    <div class="flash" id="flash"></div>
    <div class="preview-box" id="previewBox">
        <img id="previewImg">
        <div class="page-badge" id="previewBadge">0é¡µ</div>
    </div>
</div>

<div class="controls">
    <button class="side-btn" onclick="undoLast()">
        <div class="icon-circle">â†º</div>
        <span>æ’¤é”€æœ¬é¡µ</span>
    </button>

    <div class="shutter-ring" onclick="snap()">
        <div class="shutter-inner"></div>
    </div>

    <button class="side-btn btn-next" onclick="nextStudent()">
        <div class="icon-circle">âœ</div>
        <span>å®Œæˆæ­¤äºº<br>ä¸‹ä¸€ä½</span>
    </button>
</div>

<div id="loading">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:bold">æ­£åœ¨å‹ç¼©æ‰“åŒ…...</div>
    <div style="font-size:12px; color:#aaa; margin-top:5px">è¯·ä¸è¦å…³é—­é¡µé¢</div>
</div>

<canvas id="canvas" style="display:none"></canvas>

<script>
    // === æ ¸å¿ƒæ•°æ® ===
    // å­˜å‚¨ç»“æ„: { "1": [blob1, blob2], "2": [blob1], ... }
    let allData = {}; 
    let studentId = 1;
    let currentBatch = []; // å½“å‰æ­£åœ¨æ‹çš„è¿™ä¸ªå­¦ç”Ÿçš„ç…§ç‰‡

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // 1. åˆå§‹åŒ–ç›¸æœº
    async function init() {
        try {
            // ä¼˜å…ˆå°è¯•é«˜æ¸…åç½®
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1440 } } 
            });
            video.srcObject = stream;
        } catch (e) {
            alert("æ— æ³•å¯åŠ¨ç›¸æœºã€‚è¯·ä½¿ç”¨ Safari (iOS) æˆ– Chrome (Android)ï¼Œå¹¶ç¡®ä¿ç½‘å€æ˜¯ HTTPS æˆ– file://");
        }
    }
    init();

    // 2. æ‹ç…§ (è‡ªåŠ¨å‹ç¼©é˜²æ­¢å†…å­˜æº¢å‡º)
    function snap() {
        if (!video.videoWidth) return;
        
        // é—ªå…‰åŠ¨ç”»
        const f = document.getElementById('flash');
        f.style.opacity = 0.8; setTimeout(()=>f.style.opacity=0, 150);

        // é™åˆ¶å°ºå¯¸ï¼šæœ€å¤§è¾¹é•¿ 1600px (çº¦ 200ä¸‡åƒç´ )ï¼Œæ—¢æ¸…æ™°åˆçœå†…å­˜
        const maxSide = 1600;
        let w = video.videoWidth;
        let h = video.videoHeight;
        if (w > maxSide || h > maxSide) {
            const r = Math.min(maxSide/w, maxSide/h);
            w *= r; h *= r;
        }

        canvas.width = w;
        canvas.height = h;
        
        // ç®€å•å¢å¼º
        ctx.filter = "contrast(1.1) brightness(1.05)";
        ctx.drawImage(video, 0, 0, w, h);

        // å­˜ä¸º Blob (0.8è´¨é‡)
        canvas.toBlob(blob => {
            currentBatch.push(blob);
            updateUI();
        }, 'image/jpeg', 0.8);
    }

    // 3. æ’¤é”€ä¸Šä¸€é¡µ
    function undoLast() {
        if (currentBatch.length === 0) return;
        currentBatch.pop();
        updateUI();
    }

    // 4. ä¸‹ä¸€ä½ (å­˜å…¥å†…å­˜ï¼Œä¸ä¸‹è½½)
    function nextStudent() {
        if (currentBatch.length === 0) {
            // è¯¯è§¦ä¿æŠ¤
            if(!confirm("å½“å‰å­¦ç”Ÿè¿˜æ²¡æ‹ç…§ï¼Œç¡®å®šè¦è·³è¿‡å—ï¼Ÿ")) return;
        }

        // ä¿å­˜åˆ°å¤§å¯¹è±¡
        if(currentBatch.length > 0) {
            allData[studentId] = [...currentBatch];
        }
        
        // ç®€å•çš„æˆåŠŸåé¦ˆ
        const hud = document.querySelector('.current-hud');
        const oldText = hud.innerHTML;
        hud.innerHTML = `âœ… å­¦ç”Ÿ ${studentId} å·²ä¿å­˜`;
        hud.style.background = "rgba(16, 185, 129, 0.6)";
        
        setTimeout(() => {
            studentId++;
            currentBatch = [];
            hud.innerHTML = `å½“å‰: å­¦ç”Ÿ <span id="currId" style="font-size:1.3em; color:#fff">${studentId}</span> (ç¬¬ <span id="currPage">0</span> é¡µ)`;
            hud.style.background = ""; // æ¢å¤æ ·å¼
            updateUI();
        }, 500);
    }

    // 5. æœ€ç»ˆå¯¼å‡º
    function exportAll() {
        // æ£€æŸ¥ï¼šå¦‚æœå½“å‰å­¦ç”Ÿæ‹äº†ä¸€åŠæ²¡ç‚¹â€œä¸‹ä¸€ä½â€ï¼Œè¯¢é—®æ˜¯å¦åŒ…å«
        if (currentBatch.length > 0) {
            if(confirm(`æ£€æµ‹åˆ°â€œå­¦ç”Ÿ ${studentId}â€è¿˜æœ‰ç…§ç‰‡æœªå½’æ¡£ï¼Œè¦ä¸€èµ·æ‰“åŒ…å—ï¼Ÿ`)) {
                allData[studentId] = [...currentBatch];
            } else {
                return; // ç”¨æˆ·å–æ¶ˆ
            }
        }

        const ids = Object.keys(allData);
        if (ids.length === 0) return alert("è¿˜æ²¡æœ‰ä»»ä½•æ•°æ®ï¼");

        // æ˜¾ç¤ºåŠ è½½å±‚
        document.getElementById('loading').style.display = 'flex';

        const zip = new JSZip();
        
        // éå†æ‰“åŒ…
        ids.forEach(sid => {
            const pages = allData[sid];
            pages.forEach((blob, idx) => {
                // è‡ªåŠ¨å‘½åï¼š1.1.jpg, 1.2.jpg (æ”¹å·ç«¯èƒ½è‡ªåŠ¨è¯†åˆ«)
                zip.file(`${sid}.${idx + 1}.jpg`, blob);
            });
        });

        // ç”Ÿæˆæ–‡ä»¶
        zip.generateAsync({type:"blob"}).then(content => {
            document.getElementById('loading').style.display = 'none';
            
            const date = new Date();
            const timeStr = `${date.getHours()}ç‚¹${date.getMinutes()}åˆ†`;
            saveAs(content, `å…¨ç­ä½œä¸š_${ids.length}äºº_${timeStr}.zip`);
            
            // å¯¼å‡ºæˆåŠŸåæç¤º
            if(confirm("âœ… å¯¼å‡ºæˆåŠŸï¼\n\næ˜¯å¦æ¸…ç©ºæ‰€æœ‰å·²æ‹æ•°æ®ï¼Œå‡†å¤‡æ‰«ææ–°çš„ç­çº§ï¼Ÿ")) {
                location.reload();
            }
        });
    }

    // UIæ›´æ–°
    function updateUI() {
        // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
        const savedCount = Object.keys(allData).length;
        document.getElementById('totalSaved').innerText = savedCount;
        
        // ä¼°ç®—å†…å­˜: å‡è®¾æ¯å¼ å›¾ 0.4MB
        let totalPages = currentBatch.length;
        Object.values(allData).forEach(arr => totalPages += arr.length);
        const mem = (totalPages * 0.4).toFixed(1);
        document.getElementById('memUsage').innerText = mem;
        
        // å†…å­˜è­¦å‘Š (è¶…è¿‡300MBå˜çº¢)
        const stats = document.querySelector('.stats');
        if (mem > 300) stats.style.color = "#fb7185";
        else stats.style.color = "#aaa";

        // å¯ç”¨å¯¼å‡ºæŒ‰é’®
        document.getElementById('btnExport').disabled = (savedCount === 0 && currentBatch.length === 0);

        // æ›´æ–°ä¸­é—´HUD
        const cId = document.getElementById('currId');
        if(cId) cId.innerText = studentId;
        const cPg = document.getElementById('currPage');
        if(cPg) cPg.innerText = currentBatch.length;

        // æ›´æ–°é¢„è§ˆå›¾
        const box = document.getElementById('previewBox');
        if (currentBatch.length > 0) {
            box.style.display = 'block';
            const lastBlob = currentBatch[currentBatch.length-1];
            document.getElementById('previewImg').src = URL.createObjectURL(lastBlob);
            document.getElementById('previewBadge').innerText = `${currentBatch.length}é¡µ`;
        } else {
            box.style.display = 'none';
        }
    }

    // é˜²è¯¯è§¦åˆ·æ–°
    window.onbeforeunload = function() {
        if (Object.keys(allData).length > 0 || currentBatch.length > 0) {
            return "æ•°æ®æœªå¯¼å‡ºï¼Œç¡®å®šè¦åˆ·æ–°å—ï¼Ÿ";
        }
    };
</script>
</body>
</html>