<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºæ‰¹ AI V11.3ï¼ˆè‡ªåŠ¨æ‹¼å›¾åˆå¹¶ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(18, 26, 44, .82);
      --panel2: rgba(18, 26, 44, .58);
      --text:#eaf1ff;
      --muted:#9fb0d0;
      --primary:#38bdf8;
      --accent:#8b5cf6;
      --good:#10b981;
      --bad:#fb7185;
      --border: 1px solid rgba(255,255,255,.10);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(139,92,246,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 80%, rgba(56,189,248,.16), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex; flex-direction:column;
    }
    header{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; border-bottom:var(--border);
      background:rgba(8, 13, 25, .55);
      backdrop-filter: blur(12px);
      z-index:50;
    }
    .brand{
      font-weight:900; letter-spacing:1px;
      font-size:18px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      -webkit-background-clip:text; color:transparent;
    }
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:none; cursor:pointer; font-weight:800;
      padding:8px 12px; border-radius:10px;
      color:#061225; background:var(--primary);
      box-shadow:0 0 18px rgba(56,189,248,.15);
      transition:.15s;
      user-select:none;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{filter:brightness(1.06); transform:translateY(-1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn-ghost{
      background:transparent; color:var(--muted);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
    }
    .btn-ghost:hover{border-color:rgba(255,255,255,.35); color:var(--text)}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    main{flex:1; display:flex; min-height:0}

    /* å·¦ä¾§å›¾ç‰‡åŒº */
    .left{
      flex:1.55; min-width:520px;
      position:relative; overflow:hidden;
      border-right:var(--border);
    }
    .left.hidden{display:none}
    .viewport{
      position:absolute; inset:0;
      background:#050a14;
      background-image: radial-gradient(rgba(255,255,255,.12) 1px, transparent 1px);
      background-size:26px 26px;
      cursor:grab; user-select:none;
    }
    .viewport:active{cursor:grabbing}
    .canvas-wrapper{
      position:absolute; top:0; left:0;
      transform-origin:0 0;
      transition:none;
      box-shadow: var(--shadow);
    }
    #essayImg{display:block; max-width:none; pointer-events:none}
    #overlayCanvas{
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    #focusBox{
      position:absolute; border:2px solid var(--primary);
      box-shadow:0 0 18px rgba(56,189,248,.7);
      display:none; pointer-events:none; z-index:10;
    }
    .flash{animation:flash 1.4s infinite}
    @keyframes flash{0%{opacity:1}50%{opacity:.35}100%{opacity:1}}
    .empty{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      text-align:center; opacity:.35; pointer-events:none;
    }
    .empty .big{font-size:44px}
    .empty .sub{margin-top:8px; letter-spacing:2px}

    /* å³ä¾§é€‰é¡¹å¡é¢æ¿ï¼ˆæ›´å¤§ï¼‰ */
    .right{
      width:700px; max-width:56vw; min-width:520px;
      display:flex; flex-direction:column; min-height:0;
      background:var(--panel);
      backdrop-filter: blur(16px);
      box-shadow: -10px 0 32px rgba(0,0,0,.35);
    }
    .tabbar{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-bottom:var(--border);
      background:rgba(0,0,0,.18);
      position:sticky; top:0; z-index:20;
    }
    .tab{
      cursor:pointer;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      letter-spacing:1px;
      text-transform:uppercase;
      transition:.12s;
      user-select:none;
      white-space:nowrap;
    }
    .tab:hover{border-color:rgba(255,255,255,.25); color:var(--text)}
    .tab.active{
      border-color:rgba(56,189,248,.55);
      color:var(--text);
      background:rgba(56,189,248,.10);
      box-shadow:0 0 18px rgba(56,189,248,.10);
    }
    .tabbar .spacer{flex:1}
    .panel{
      flex:1; min-height:0;
      overflow:auto;
      padding:12px 14px;
    }

    /* è¡¨å•/å¡ç‰‡ */
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .field{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px; padding:10px;
    }
    .field label{
      font-size:11px; color:var(--muted);
      letter-spacing:1px; text-transform:uppercase;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
      font-weight:900;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; border-radius:12px; padding:10px 10px;
      background:rgba(5,10,20,.65);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:130px; resize:vertical; line-height:1.4}
    input:focus, textarea:focus, select:focus{border-color:rgba(56,189,248,.55)}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}

    .card{
      background:rgba(255,255,255,.03);
      border:var(--border);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
      transition:.12s;
    }
    .card:hover{background:rgba(255,255,255,.045); transform:translateY(-1px)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .status{
      font-size:12px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      color:var(--muted);
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .status.running{border-color:rgba(56,189,248,.5); color:var(--primary)}
    .status.done{border-color:rgba(16,185,129,.45); color:var(--good)}
    .status.err{border-color:rgba(251,113,133,.55); color:var(--bad)}
    .file{
      font-size:13px; font-weight:900;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width:420px;
    }
    .kpi{font-size:12px; color:var(--muted)}
    .kpi b{color:var(--text)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:12px 0}

    /* ç»“æœå±•ç¤ºï¼ˆæ›´å®½ã€æ›´åˆ†åŒºï¼‰ */
    .scoreBig{
      font-size:54px; font-weight:900; color:var(--primary);
      line-height:1;
      text-shadow:0 0 26px rgba(56,189,248,.22);
    }
    .rubric{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;
    }
    .rubItem{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:10px;
    }
    .rubHead{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; font-weight:900}
    .bar{height:6px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden; margin-top:8px}
    .fill{height:100%; background:var(--accent); width:0; transition:width .8s ease}
    .rubCmt{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}

    .sectionTitle{
      font-size:12px; letter-spacing:1px; text-transform:uppercase;
      color:var(--muted); font-weight:900;
      display:flex; align-items:center; justify-content:space-between;
      margin:14px 0 10px;
    }
    .box{
      border-left:3px solid var(--primary);
      background:linear-gradient(90deg, rgba(56,189,248,.08), transparent);
      padding:10px 12px; border-radius:0 12px 12px 0;
      font-size:14px; line-height:1.6;
    }
    .box small{display:block; color:var(--muted); margin-top:6px}

    /* å­é€‰é¡¹å¡ */
    .subtabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .subtab{
      cursor:pointer;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .subtab.active{
      border-color:rgba(56,189,248,.55);
      color:var(--text);
      background:rgba(56,189,248,.10);
    }

    /* æ‰¹æ³¨ */
    .anno{
      display:flex; gap:10px; padding:10px; border-radius:14px;
      border:1px solid transparent;
      background:rgba(0,0,0,.18);
      cursor:pointer; transition:.12s;
      margin-bottom:10px;
    }
    .anno:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.10)}
    .anno.active{border-color:rgba(56,189,248,.55); background:rgba(56,189,248,.10)}
    .badge{
      font-size:11px; font-weight:900; padding:2px 7px; border-radius:8px;
      height:fit-content; white-space:nowrap;
      border:1px solid;
    }
    .badge.err{color:var(--bad); border-color:rgba(251,113,133,.45); background:rgba(251,113,133,.10)}
    .badge.good{color:var(--good); border-color:rgba(16,185,129,.40); background:rgba(16,185,129,.10)}
    .del{color:#7182a8; text-decoration:line-through; margin-right:6px}
    .fix{color:var(--good); font-weight:900}
    .reason{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35}

    /* Modalï¼ˆKeyï¼‰ */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.78); z-index:200;
    }
    .modal-box{
      width:min(560px, 92vw);
      background:#0c1430;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modal-title{font-weight:900; margin:0 0 8px}
    .modal-sub{font-size:13px; color:var(--muted); line-height:1.45}
    .modal-actions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}

    /* Debug */
    .debug{
      position:fixed; right:12px; bottom:12px;
      width:min(640px, 92vw);
      max-height:72vh;
      display:none;
      z-index:300;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(6,10,20,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .debug-head{
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
    }
    .debug-body{padding:10px 12px; overflow:auto; max-height:calc(72vh - 46px)}
    pre{
      margin:0; white-space:pre-wrap; word-break:break-word;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px; color:#d8e3ff;
      line-height:1.35;
    }

    /* å°å·¥å…· */
    .right-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
  </style>
</head>

<body>

<header>
  <div style="display:flex; gap:10px; align-items:center">
    <div class="brand">ğŸ¦‰ æ™ºæ‰¹ AI V11.3</div>
    <div class="pill" id="keyState">Keyï¼šæœªè®¾ç½®</div>
    <div class="pill">é¢˜å›¾ï¼š<span id="promptState">æœªè®¾ç½®</span></div>
    <div class="pill">é˜Ÿåˆ—ï¼š<span id="qState">0</span> | å®Œæˆï¼š<span id="doneState">0</span></div>
  </div>

  <div class="top-actions">
    <button class="btn-ghost btn" id="btnToggleLeft">ğŸªŸ å·¦ä¾§å›¾ç‰‡åŒº</button>
    <button class="btn-ghost btn" id="btnKey">ğŸ”‘ è®¾ç½®Key</button>
    <button class="btn-ghost btn" id="btnPromptImg">ğŸ–¼ï¸ ä¸Šä¼ é¢˜å›¾</button>
    <button class="btn" id="btnUpload">ğŸ“· æ‰¹é‡ä¸Šä¼ ä½œæ–‡</button>
    <button class="btn-ghost btn" id="btnStart">â–¶ å¼€å§‹æ‰¹æ”¹</button>
    <button class="btn-ghost btn" id="btnDebug">ğŸ§ª è°ƒè¯•</button>
  </div>
</header>

<main>
  <div class="left" id="leftPane">
    <div class="viewport" id="viewport">
      <div class="canvas-wrapper" id="wrapper">
        <img id="essayImg" alt="">
        <canvas id="overlayCanvas"></canvas>
        <div id="focusBox"></div>
      </div>
      <div class="empty" id="empty">
        <div class="big">ğŸ“„</div>
        <div class="sub">UPLOAD ESSAYS</div>
        <div class="hint" style="margin-top:10px; color:#666">æ”¯æŒå¤šé¡µè‡ªåŠ¨åˆå¹¶ (å¦‚ 1.1.jpg, 1.2.jpg)</div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="tabbar">
      <div class="tab active" data-tab="queue">é˜Ÿåˆ—</div>
      <div class="tab" data-tab="result">ç»“æœ</div>
      <div class="tab" data-tab="settings">è®¾ç½®</div>
      <div class="tab" data-tab="export">å¯¼å‡º</div>
      <div class="spacer"></div>
      <div class="right-actions">
        <button class="btn-ghost btn" id="btnSelectNext">â­ ä¸‹ä¸€ç¯‡</button>
        <button class="btn-ghost btn" id="btnSelectPrev">â® ä¸Šä¸€ç¯‡</button>
      </div>
    </div>

    <div class="panel" id="panelQueue"></div>
    <div class="panel" id="panelResult" style="display:none"></div>
    <div class="panel" id="panelSettings" style="display:none"></div>
    <div class="panel" id="panelExport" style="display:none"></div>
  </div>
</main>

<input id="essayFiles" type="file" accept="image/*" multiple style="display:none"/>
<input id="promptFile" type="file" accept="image/*" style="display:none"/>

<div class="modal" id="keyModal">
  <div class="modal-box">
    <h3 class="modal-title">ğŸ” è®¾ç½®æ™ºè°± API Key</h3>
    <div class="modal-sub">
      Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ˆsessionStorageï¼‰ã€‚å…³é—­é¡µé¢ä¼šæ¸…ç©ºã€‚<br/>
      å¦‚æœä½ åœ¨å…¬å…±ç”µè„‘ç”¨ï¼Œå»ºè®®ç”¨å®Œå°±å…³æ‰é¡µé¢ã€‚
    </div>
    <input id="keyInput" type="text" placeholder="sk-..." style="margin-top:12px"/>
    <div class="modal-actions">
      <button class="btn-ghost btn" id="btnKeyCancel">å–æ¶ˆ</button>
      <button class="btn" id="btnKeySave">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="debug" id="debugPanel">
  <div class="debug-head">
    <div>ğŸ§ª è°ƒè¯•é¢æ¿ï¼ˆæœ€è¿‘ä¸€æ¬¡è¯·æ±‚/è¿”å›ï¼‰</div>
    <div style="display:flex; gap:8px">
      <button class="btn-ghost btn" id="btnCopyReq">å¤åˆ¶è¯·æ±‚ä½“</button>
      <button class="btn-ghost btn" id="btnCopyRes">å¤åˆ¶è¿”å›</button>
      <button class="btn-ghost btn" id="btnCloseDbg">å…³é—­</button>
    </div>
  </div>
  <div class="debug-body">
    <div class="hint" style="margin-bottom:6px">è¯·æ±‚ä½“ï¼š</div>
    <pre id="dbgReq"></pre>
    <div class="divider"></div>
    <div class="hint" style="margin-bottom:6px">è¿”å›ï¼š</div>
    <pre id="dbgRes"></pre>
  </div>
</div>

<script>
/** =========================
 *  0. é»˜è®¤é‡è¡¨ï¼ˆå¯æ”¹ï¼‰
 *  ========================= */
const DEFAULT_RUBRIC = {
  total: 100,
  dims: {
    content: { max: 30 },
    structure: { max: 20 },
    language: { max: 30 },
    neatness: { max: 20 }
  }
};

/** =========================
 *  1. å…¨å±€çŠ¶æ€
 *  ========================= */
const API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";

const STATE = {
  apiKey: sessionStorage.getItem("zp_key_v112") || "",
  promptImg: null,  // dataURL
  jobs: [],         // {id,name,essayDataUrl,status,result,err,rawVision,rawText,startedAt,endedAt}
  done: 0,
  selectedJobId: null,

  // viewport pan/zoom
  scale: 1,
  panX: 0,
  panY: 0,
  dragging:false,
  sx:0, sy:0,

  // UI tab states
  mainTab: "queue",
  resultSubTab: "overview",

  // debug
  lastReq: null,
  lastRes: null,

  // left shown
  leftShown: true,
};

/** =========================
 *  2. DOM
 *  ========================= */
const $ = (id)=>document.getElementById(id);

const keyModal = $("keyModal");
const keyState = $("keyState");
const promptState = $("promptState");
const qState = $("qState");
const doneState = $("doneState");

const panelQueue = $("panelQueue");
const panelResult = $("panelResult");
const panelSettings = $("panelSettings");
const panelExport = $("panelExport");

const essayFiles = $("essayFiles");
const promptFile = $("promptFile");

const leftPane = $("leftPane");

const viewport = $("viewport");
const wrapper = $("wrapper");
const essayImg = $("essayImg");
const overlayCanvas = $("overlayCanvas");
const octx = overlayCanvas.getContext("2d");
const focusBox = $("focusBox");
const empty = $("empty");

const dbgPanel = $("debugPanel");
const dbgReq = $("dbgReq");
const dbgRes = $("dbgRes");

/** =========================
 *  3. å·¥å…·å‡½æ•°
 *  ========================= */
function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function safeJsonParse(txt){
  try { return JSON.parse(txt); } catch { return null; }
}
function extractJsonObject(str){
  if(!str) return null;
  const t = String(str).replace(/```json|```/g,"").trim();
  const a = t.indexOf("{");
  const b = t.lastIndexOf("}");
  if(a === -1 || b === -1 || b <= a) return null;
  return t.slice(a, b+1);
}
function now(){ return new Date().toISOString(); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
async function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

// æ”¹è¿›åçš„å‹ç¼©å‡½æ•°ï¼šå¯¹é•¿å›¾æ›´å‹å¥½
async function compressDataUrl(dataUrl, maxSide=1100, quality=0.78){
  const img = new Image();
  img.src = dataUrl;
  await new Promise(res=>img.onload=res);

  let w = img.naturalWidth, h = img.naturalHeight;
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºé•¿å›¾ (å¦‚3é¡µæ‹¼åœ¨ä¸€èµ·çš„è¯•å·)
  const isLongStrip = h > w * 2.2;

  if(isLongStrip){
    // é•¿å›¾ç­–ç•¥ï¼šé™åˆ¶å®½åº¦ï¼Œé«˜åº¦å…è®¸æŒ‰æ¯”ä¾‹å»¶ä¼¸ï¼ˆä¿ç•™æ¸…æ™°åº¦ï¼‰
    if(w > maxSide){
      const r = maxSide / w;
      w = Math.round(w * r);
      h = Math.round(h * r);
    }
    // äºŒæ¬¡æ£€æŸ¥ï¼šå¦‚æœé«˜åº¦å®åœ¨å¤ªå¤¸å¼ ï¼ˆå¦‚è¶…è¿‡8000pxï¼‰ï¼Œå¼ºåˆ¶é™åˆ¶é«˜åº¦
    if(h > 8000){
      const r = 8000 / h;
      w = Math.round(w * r);
      h = Math.round(h * r);
    }
  } else {
    // æ™®é€šå›¾ç‰‡ï¼šé™åˆ¶æœ€é•¿è¾¹
    if(w > maxSide || h > maxSide){
      const r = Math.min(maxSide/w, maxSide/h);
      w = Math.round(w*r);
      h = Math.round(h*r);
    }
  }

  const c = document.createElement("canvas");
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h); // é˜²æ­¢é€æ˜èƒŒæ™¯å˜é»‘
  ctx.drawImage(img, 0,0,w,h);
  return c.toDataURL("image/jpeg", quality);
}

// å‚ç›´æ‹¼å›¾å‡½æ•°
async function stitchImages(dataUrlList) {
  if (!dataUrlList || dataUrlList.length === 1) return dataUrlList[0];

  const images = await Promise.all(dataUrlList.map(src => {
    return new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = src; });
  }));

  const w = images[0].naturalWidth;
  let h = 0;
  images.forEach(img => h += img.naturalHeight * (w / img.naturalWidth));

  // å®‰å…¨é™åˆ¶
  const maxH = 16000;
  const scale = h > maxH ? (maxH / h) : 1;

  const canvas = document.createElement("canvas");
  canvas.width = w * scale;
  canvas.height = h * scale;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height);

  let y = 0;
  images.forEach(img => {
    const drawH = (img.naturalHeight * (w / img.naturalWidth)) * scale;
    ctx.drawImage(img, 0, y, canvas.width, drawH);
    // ç”»ä¸€æ¡åˆ†å‰²çº¿
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); 
    ctx.strokeStyle="rgba(0,0,0,0.1)"; ctx.lineWidth=2; ctx.stroke();
    y += drawH;
  });

  return canvas.toDataURL("image/jpeg", 0.85);
}

function downloadText(filename, text, mime="application/octet-stream"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function copyToClipboard(text){
  navigator.clipboard?.writeText(text).catch(()=>{});
}

/** =========================
 *  4. è®¾ç½®é¡¹ï¼ˆä¿å­˜åœ¨localStorageï¼‰
 *  ========================= */
function getSettings(){
  const topic = (localStorage.getItem("zp_topic_v112") || "").trim();
  const mode  = (localStorage.getItem("zp_mode_v112") || "std");
  const rawRub = (localStorage.getItem("zp_rubric_v112") || "");
  const rubricObj = safeJsonParse(rawRub) || DEFAULT_RUBRIC;

  const visionModel = localStorage.getItem("zp_vision_model_v112") || "glm-4v-flash";
  const textModel   = localStorage.getItem("zp_text_model_v112") || "glm-4.6";
  const maxSide     = Number(localStorage.getItem("zp_imgmax_v112") || "1100");
  const concurrency = Math.max(1, Math.min(6, Number(localStorage.getItem("zp_conc_v112") || "2")));

  const visionModels = [visionModel, "glm-4v-flash", "glm-4v", "glm-4.6v-flash"].filter((v,i,a)=>v && a.indexOf(v)===i);
  const textModels   = [textModel, "glm-4.6", "glm-4", "glm-4-flash"].filter((v,i,a)=>v && a.indexOf(v)===i);

  return {topic, mode, rubricObj, visionModels, textModels, maxSide, concurrency};
}

/** =========================
 *  5. äº¤äº’ï¼šæ‹–æ‹½/ç¼©æ”¾/å®šä½
 *  ========================= */
function updateTransform(animate=false){
  wrapper.style.transition = animate ? "transform .45s cubic-bezier(.2,.8,.2,1)" : "none";
  wrapper.style.transform = `translate(${STATE.panX}px, ${STATE.panY}px) scale(${STATE.scale})`;
}
viewport.addEventListener("mousedown", (e)=>{
  STATE.dragging=true;
  STATE.sx = e.clientX - STATE.panX;
  STATE.sy = e.clientY - STATE.panY;
  viewport.style.cursor="grabbing";
});
window.addEventListener("mousemove",(e)=>{
  if(!STATE.dragging) return;
  e.preventDefault();
  STATE.panX = e.clientX - STATE.sx;
  STATE.panY = e.clientY - STATE.sy;
  updateTransform(false);
});
window.addEventListener("mouseup", ()=>{
  STATE.dragging=false;
  viewport.style.cursor="grab";
});
viewport.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const speed = 0.12;
  const dir = e.deltaY>0 ? -1 : 1;
  const factor = 1 + dir*speed;

  const rect = wrapper.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const old = STATE.scale;
  let ns = old * factor;
  ns = Math.max(0.12, Math.min(ns, 6));

  STATE.panX -= (mx / old) * (ns - old);
  STATE.panY -= (my / old) * (ns - old);
  STATE.scale = ns;

  updateTransform(false);
},{passive:false});

function initCanvasForImage(imgW, imgH){
  overlayCanvas.width = imgW;
  overlayCanvas.height= imgH;

  const vpW = viewport.clientWidth;
  const vpH = viewport.clientHeight;
  const s = Math.min(vpW/imgW, vpH/imgH) * 0.92;
  STATE.scale = s;
  STATE.panX = (vpW - imgW*s)/2;
  STATE.panY = (vpH - imgH*s)/2;
  updateTransform(false);
}
function drawBoxes(annotations, imgW, imgH){
  octx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  (annotations||[]).forEach(a=>{
    if(!a?.pos || a.pos.length!==4) return;
    const [ymin,xmin,ymax,xmax] = a.pos;
    const x = (xmin/1000)*imgW;
    const y = (ymin/1000)*imgH;
    const w = ((xmax-xmin)/1000)*imgW;
    const h = ((ymax-ymin)/1000)*imgH;

    const isErr = a.type === "error";
    octx.lineWidth = 3;
    octx.strokeStyle = isErr ? "#fb7185" : "#10b981";
    octx.fillStyle   = isErr ? "rgba(251,113,133,.14)" : "rgba(16,185,129,.14)";
    octx.strokeRect(x,y,w,h);
    octx.fillRect(x,y,w,h);
  });
}
function showFocus(pos){
  if(!pos || pos.length !== 4) return;
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);
  if(!job?.result?.ocr_meta?.imgW) return;

  const imgW = job.result.ocr_meta.imgW;
  const imgH = job.result.ocr_meta.imgH;

  const [ymin,xmin,ymax,xmax] = pos;
  const x = (xmin/1000)*imgW;
  const y = (ymin/1000)*imgH;
  const w = ((xmax-xmin)/1000)*imgW;
  const h = ((ymax-ymin)/1000)*imgH;

  const cx = x + w/2;
  const cy = y + h/2;
  const targetScale = Math.max(STATE.scale, 0.85);
  STATE.scale = targetScale;
  STATE.panX = (viewport.clientWidth/2) - (cx*targetScale);
  STATE.panY = (viewport.clientHeight/2) - (cy*targetScale);
  updateTransform(true);

  focusBox.style.display = "block";
  focusBox.style.left = x + "px";
  focusBox.style.top  = y + "px";
  focusBox.style.width = w + "px";
  focusBox.style.height= h + "px";
  focusBox.classList.remove("flash");
  void focusBox.offsetWidth;
  focusBox.classList.add("flash");
  clearTimeout(window.__flashTimer);
  window.__flashTimer = setTimeout(()=>focusBox.style.display="none", 2600);
}

/** =========================
 *  6. Prompt ç”Ÿæˆï¼ˆä¸¤æ®µå¼ï¼‰
 *  ========================= */
function buildVisionPrompt(topic, rubricObj, mode, hasPromptImage){
  return [
`ä½ æ˜¯ä¸€ä½å°å­¦è¯­æ–‡ç‰¹çº§æ•™å¸ˆåŠ©æ•™ï¼Œä»ã€ä½œæ–‡ç…§ç‰‡ã€‘æå–OCRæ–‡æœ¬å¹¶å®šä½æ‰¹æ³¨ä½ç½®ã€‚`,
`åªè¾“å‡ºä¸€ä¸ªã€JSONå¯¹è±¡ã€‘ï¼ˆä¸è¦Markdownï¼Œä¸è¦å¤šä½™è§£é‡Šï¼‰ã€‚`,
`å¿…é¡»åŒ…å«å­—æ®µï¼š`,
`{ "ocr_text": "...", "annotations":[{"type":"error|good","text":"...","fix":"...","reason":"...","pos":[ymin,xmin,ymax,xmax]}], "picture_desc":"..." }`,
`è¦æ±‚ï¼š`,
`1) annotations è‡³å°‘ 6 æ¡ï¼ˆé”™åˆ«å­—/ç—…å¥/æ ‡ç‚¹/é‡å¤/äº®ç‚¹å¥å°½é‡éƒ½è¦†ç›–ï¼‰ã€‚`,
`2) pos ç”¨ 0-1000 ç›¸å¯¹åæ ‡ï¼ˆymin,xmin,ymax,xmaxï¼‰ã€‚`,
`3) ä¸è¦è¾“å‡º reasoning_contentã€‚`,
`è¡¥å……ï¼šé¢˜ç›®/ä»»åŠ¡ï¼š${topic ? topic : "ï¼ˆæœªæä¾›ï¼ŒæŒ‰ä½œæ–‡å†…å®¹åˆ¤æ–­ï¼‰"}ï¼›æ¨¡å¼ï¼š${mode}ï¼›æ˜¯å¦æä¾›é¢˜å›¾ï¼š${hasPromptImage?"æ˜¯":"å¦"}`
  ].join("\n");
}
function buildTextPrompt(topic, rubricObj, mode, visionJson){
  const wantFast = (mode === "fast");
  const wantPro  = (mode === "pro");

  const schemaStd = `
{
  "total_score": 90,
  "rubric": {
    "content":   {"score": 26, "max": 30, "comment": "......"},
    "structure": {"score": 18, "max": 20, "comment": "......"},
    "language":  {"score": 27, "max": 30, "comment": "......"},
    "neatness":  {"score": 19, "max": 20, "comment": "......"}
  },
  "teacher_comment": "80-120å­—ï¼Œå…ˆæ‰¬åæŠ‘ï¼Œå…·ä½“å¯æ“ä½œ",
  "improvements": {
    "å®¡é¢˜ç«‹æ„": ["1-2æ¡"],
    "å†…å®¹ç»†èŠ‚": ["1-2æ¡"],
    "ç»“æ„æ¡ç†": ["1-2æ¡"],
    "è¯­è¨€è¡¨è¾¾": ["1-2æ¡"],
    "æ ‡ç‚¹ä¹¦å†™": ["1-2æ¡"],
    "é”™åˆ«å­—ç—…å¥": ["1-2æ¡"]
  },
  "rewrite": {"original":"åŸå¥","improved":"å‡æ ¼å¥","technique":"æŠ€å·§"},
  "model_essay": {"title":"èŒƒæ–‡é¢˜ç›®","text":"120-180å­—èŒƒæ–‡","highlights":["äº®ç‚¹1","äº®ç‚¹2"]},
  "exercises": [
    {"q":"é¢˜ç›®1","answer":"ç­”æ¡ˆ1","skill":"èƒ½åŠ›ç‚¹"},
    {"q":"é¢˜ç›®2","answer":"ç­”æ¡ˆ2","skill":"èƒ½åŠ›ç‚¹"}
  ],
  "annotations": [
    {"type":"error|good","text":"åŸæ–‡ç‰‡æ®µ","fix":"ä¿®æ”¹å»ºè®®(äº®ç‚¹å¯ç©º)","reason":"è§£é‡Š","pos":[ymin,xmin,ymax,xmax]}
  ],
  "ocr_text": "å…¨æ–‡OCR..."
}
`.trim();

  const schemaFast = `
{
  "total_score": 90,
  "rubric": {
    "content":   {"score": 26, "max": 30, "comment": "......"},
    "structure": {"score": 18, "max": 20, "comment": "......"},
    "language":  {"score": 27, "max": 30, "comment": "......"},
    "neatness":  {"score": 19, "max": 20, "comment": "......"}
  },
  "teacher_comment": "80-120å­—ç‚¹è¯„",
  "rewrite": {"original":"åŸå¥","improved":"å‡æ ¼å¥","technique":"æŠ€å·§"},
  "annotations": [
    {"type":"error|good","text":"åŸæ–‡ç‰‡æ®µ","fix":"ä¿®æ”¹å»ºè®®(äº®ç‚¹å¯ç©º)","reason":"è§£é‡Š","pos":[ymin,xmin,ymax,xmax]}
  ],
  "ocr_text": "å…¨æ–‡OCR..."
}
`.trim();

  const schema = wantFast ? schemaFast : schemaStd;
  const rubricText = JSON.stringify(rubricObj, null, 2);

  return [
`ä½ æ˜¯ä¸€ä½å°å­¦è¯­æ–‡ç‰¹çº§æ•™å¸ˆã€‚æ ¹æ® OCRã€é¢˜ç›®/é¢˜å›¾æè¿°ã€é˜…å·æ ‡å‡†è¾“å‡ºã€ä¸¥æ ¼åˆæ³•JSONå¯¹è±¡ã€‘ã€‚`,
`ã€ç¡¬æ€§è§„åˆ™ã€‘`,
`1) åªè¾“å‡ºJSONå¯¹è±¡ï¼ˆä¸è¦Markdownï¼Œä¸è¦è§£é‡Šæ–‡å­—ï¼‰ã€‚`,
`2) rubric å››é¡¹å¿…é¡»æ˜¯å¯¹è±¡ï¼š{score,max,comment}ï¼Œmax ä½¿ç”¨é˜…å·æ ‡å‡†å¯¹åº”æ»¡åˆ†ã€‚`,
`3) total_score å¿…é¡»ç­‰äºå››é¡¹scoreä¹‹å’Œã€‚`,
`4) annotations å¿…é¡»ä¸ºå¯¹è±¡æ•°ç»„ï¼Œä¸”ä¸å°‘äº 6 æ¡ï¼ˆæ ‡å‡†/ç²¾æ‰¹å»ºè®® 8-12ï¼‰ã€‚`,
`5) ä¸è¦å‡ºç° reasoning_contentã€‚`,
`6) teacher_comment 80-120å­—ï¼Œå…ˆæ‰¬åæŠ‘ï¼Œå¯æ“ä½œå»ºè®®ã€‚`,
wantFast ? `7) æé€Ÿæ¨¡å¼å¯çœç•¥ improvements/model_essay/exercisesã€‚` : `7) æ ‡å‡†/ç²¾æ‰¹å¿…é¡»ç»™ improvementsã€model_essayã€exercisesã€‚`,
wantPro ? `8) ç²¾æ‰¹ï¼šå»ºè®®æ›´å…·ä½“ï¼Œä½†ä¸è¦è¶…é•¿é¿å…æˆªæ–­ã€‚` : `8) ç»“æœè¦æ¸…æ™°ä¸å†—é•¿ã€‚`,
`ã€ä½œæ–‡é¢˜ç›®/ä»»åŠ¡ã€‘${topic ? topic : "ï¼ˆæœªæä¾›ï¼ŒæŒ‰ocr_textä¸picture_descåˆ¤æ–­ï¼‰"}`,
`ã€é˜…å·æ ‡å‡†JSONã€‘\n${rubricText}`,
`ã€è§†è§‰æå–ç»“æœã€‘\n${JSON.stringify(visionJson, null, 2)}`,
`ã€ç›®æ ‡ç»“æ„ç¤ºä¾‹ã€‘\n${schema}`,
`ç°åœ¨è¾“å‡ºæœ€ç»ˆJSONï¼š`
  ].join("\n");
}

/** =========================
 *  7. è¯·æ±‚ï¼šå®‰å…¨ fetch + å…¼å®¹é™çº§
 *  ========================= */
async function postJSON(payload){
  if(!STATE.apiKey) throw new Error("æœªè®¾ç½®API Key");

  STATE.lastReq = payload;
  dbgReq.textContent = JSON.stringify(payload, null, 2);

  const res = await fetch(API_URL, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization": `Bearer ${STATE.apiKey}`
    },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  STATE.lastRes = text;
  dbgRes.textContent = text;

  let json = null;
  try{ json = JSON.parse(text); }catch{}

  if(!res.ok){
    const code = json?.error?.code;
    const msg  = json?.error?.message || `HTTP ${res.status}`;
    const err = new Error(msg);
    err.code = code;
    err.http = res.status;
    err.raw  = text;
    throw err;
  }
  return json;
}

async function callTextModelWithFallback(models, basePayload){
  let lastErr = null;
  for(const model of models){
    const steps = [
      (p)=>p,
      (p)=>{ const q = structuredClone(p); delete q.thinking; delete q.do_sample; return q; },
      (p)=>{ const q = structuredClone(p); delete q.response_format; delete q.thinking; delete q.do_sample; return q; }
    ];
    for(const mk of steps){
      const payload = mk(structuredClone(basePayload));
      payload.model = model;
      try{
        const out = await postJSON(payload);
        return {out, usedModel:model};
      }catch(e){
        lastErr = e;
        if(String(e.code) === "1220") break;     // æ— æƒè®¿é—®æ¨¡å‹ï¼šæ¢æ¨¡å‹
        if(String(e.code) === "1210") continue;  // å‚æ•°é—®é¢˜ï¼šæ¢step
        continue;
      }
    }
  }
  throw lastErr || new Error("æ–‡æœ¬æ¨¡å‹è°ƒç”¨å¤±è´¥");
}

async function callVisionModelWithFallback(models, basePayload){
  let lastErr = null;
  for(const model of models){
    const payload = structuredClone(basePayload);
    payload.model = model;
    delete payload.response_format;
    delete payload.thinking;
    delete payload.do_sample;

    try{
      const out = await postJSON(payload);
      return {out, usedModel:model};
    }catch(e){
      lastErr = e;
      if(String(e.code)==="1220") continue;
      if(String(e.code)==="1210") continue;
      continue;
    }
  }
  throw lastErr || new Error("è§†è§‰æ¨¡å‹è°ƒç”¨å¤±è´¥");
}

/** =========================
 *  8. JSONè‡ªæ„ˆ / ç»“æ„å½’ä¸€åŒ–
 *  ========================= */
function validateAndNormalizeFinal(finalObj, rubricObj){
  if(!finalObj || typeof finalObj !== "object") return null;

  const dims = ["content","structure","language","neatness"];
  finalObj.rubric = finalObj.rubric || {};

  for(const d of dims){
    const max = rubricObj?.dims?.[d]?.max ?? (d==="structure"?20:(d==="neatness"?20:30));
    const v = finalObj.rubric[d];

    if(typeof v === "number"){
      finalObj.rubric[d] = {score:v, max, comment:""};
    }else if(!v || typeof v !== "object"){
      finalObj.rubric[d] = {score:0, max, comment:""};
    }else{
      finalObj.rubric[d].max = (typeof v.max==="number") ? v.max : max;
      finalObj.rubric[d].score = (typeof v.score==="number") ? v.score : 0;
      finalObj.rubric[d].comment = (v.comment ?? "");
    }
  }

  const sum = dims.reduce((a,d)=>a + (Number(finalObj.rubric[d].score)||0), 0);
  finalObj.total_score = sum;

  if(!Array.isArray(finalObj.annotations)) finalObj.annotations = [];
  finalObj.annotations = finalObj.annotations
    .filter(x=>x && typeof x==="object")
    .map(x=>({
      type: x.type==="good" ? "good" : "error",
      text: x.text ?? "",
      fix:  x.fix ?? "",
      reason: x.reason ?? "",
      pos: Array.isArray(x.pos) && x.pos.length===4 ? x.pos.map(n=>Number(n)||0) : null
    }))
    .filter(x=>x.text);

  finalObj.annotations.forEach(a=>{ if(!a.pos) delete a.pos; });
  finalObj.ocr_text = finalObj.ocr_text ?? "";

  return finalObj;
}

async function repairToTarget(rawMixed, topic, rubricObj, textModels){
  const sys = "ä½ æ˜¯JSONä¿®å¤å™¨ã€‚åªè¾“å‡ºä¸¥æ ¼åˆæ³•JSONå¯¹è±¡ï¼›ä¸è¦Markdownï¼›ä¸è¦è§£é‡Šï¼›ä¸è¦reasoning_contentã€‚";
  const user = [
`æŠŠä¸‹é¢å¯èƒ½ä¸å®Œæ•´/å¤¹æ‚æ–‡æœ¬/å¸¦ä»£ç å—çš„å†…å®¹ä¿®å¤ä¸ºç›®æ ‡ç»“æ„JSONï¼š`,
`- rubric.content/structure/language/neatness å¿…é¡»æ˜¯å¯¹è±¡ {score,max,comment}`,
`- total_score = å››é¡¹scoreä¹‹å’Œ`,
`- annotations å¿…é¡»æ˜¯å¯¹è±¡æ•°ç»„ä¸”â‰¥6`,
`- ocr_text å¿…é¡»å­˜åœ¨ï¼ˆæ²¡æœ‰å°±ç»™ç©ºå­—ç¬¦ä¸²ï¼‰`,
`- ä¸è¦å‡ºç° reasoning_content`,
`ä½œæ–‡é¢˜ç›®ï¼š${topic || "ï¼ˆæœªæä¾›ï¼‰"}`,
`é˜…å·æ ‡å‡†ï¼ˆJSONï¼‰ï¼š\n${JSON.stringify(rubricObj,null,2)}`,
`åŸå§‹è¾“å‡ºï¼š\n${rawMixed || ""}`
  ].join("\n");

  const basePayload = {
    model: textModels[0],
    messages: [
      {role:"system", content: sys},
      {role:"user", content: user}
    ],
    temperature: 0,
    max_tokens: 1600,
    response_format: {type:"json_object"},
    thinking: {type:"disabled"},
    do_sample: false
  };

  const {out, usedModel} = await callTextModelWithFallback(textModels, basePayload);
  const content = out?.choices?.[0]?.message?.content || "";
  let obj = safeJsonParse(content);
  if(!obj){
    const j = extractJsonObject(content);
    obj = j ? safeJsonParse(j) : null;
  }
  if(!obj) throw new Error("JSONä¿®å¤å¤±è´¥ï¼ˆä»ä¸å¯è§£æï¼‰");
  obj.__used_text_model = usedModel;
  return obj;
}

async function expandAnnotationsIfNeeded(finalObj, topic, rubricObj, mode, textModels){
  const need = (mode==="fast") ? 6 : 8;
  if(finalObj.annotations?.length >= need) return finalObj;

  const sys = "ä½ æ˜¯ä½œæ–‡ç²¾æ‰¹åŠ©æ‰‹ã€‚åªè¾“å‡ºä¸¥æ ¼åˆæ³•JSONå¯¹è±¡ï¼›ä¸è¦Markdownï¼›ä¸è¦è§£é‡Šï¼›ä¸è¦reasoning_contentã€‚";
  const user = [
`åœ¨ä¸æ”¹å˜è¯„åˆ†æ€è·¯å‰æä¸‹ï¼ŒæŠŠ annotations è¡¥åˆ°è‡³å°‘ ${need} æ¡ã€‚`,
`æ¯æ¡å¿…é¡»æ˜¯å¯¹è±¡ï¼š{type,error/good,text,fix,reason,pos(å¯é€‰)}ã€‚`,
`åªè¾“å‡ºJSONå¯¹è±¡ã€‚`,
`ä½œæ–‡é¢˜ç›®ï¼š${topic||"ï¼ˆæœªæä¾›ï¼‰"}`,
`é˜…å·æ ‡å‡†ï¼š\n${JSON.stringify(rubricObj,null,2)}`,
`å½“å‰JSONï¼š\n${JSON.stringify(finalObj,null,2)}`
  ].join("\n");

  const basePayload = {
    model: textModels[0],
    messages: [
      {role:"system", content: sys},
      {role:"user", content: user}
    ],
    temperature: 0,
    max_tokens: 1300,
    response_format: {type:"json_object"},
    thinking: {type:"disabled"},
    do_sample: false
  };

  const {out, usedModel} = await callTextModelWithFallback(textModels, basePayload);
  const content = out?.choices?.[0]?.message?.content || "";
  let obj = safeJsonParse(content);
  if(!obj){
    const j = extractJsonObject(content);
    obj = j ? safeJsonParse(j) : null;
  }
  if(!obj) return finalObj;
  obj.__used_text_model = usedModel;
  return obj;
}

/** =========================
 *  9. å•ç¯‡æ‰¹æ”¹ï¼ˆä¸¤æ®µå¼ï¼‰
 *  ========================= */
async function analyzeJob(job){
  const {topic, mode, rubricObj, visionModels, textModels, maxSide} = getSettings();
  job.startedAt = Date.now();

  const essayCompressed = await compressDataUrl(job.essayDataUrl, maxSide, 0.78);

  // è§†è§‰æå–ï¼ˆå¯é€‰é¢˜å›¾ï¼‰
  const visionPrompt = buildVisionPrompt(topic, rubricObj, mode, !!STATE.promptImg);
  const contentArr = [{type:"text", text: visionPrompt}];

  if(STATE.promptImg){
    const promptCompressed = await compressDataUrl(STATE.promptImg, maxSide, 0.82);
    contentArr.push({type:"image_url", image_url:{url: promptCompressed}});
  }
  contentArr.push({type:"image_url", image_url:{url: essayCompressed}});

  const visionPayload = {
    model: visionModels[0],
    messages: [{role:"user", content: contentArr}],
    temperature: 0.1,
    max_tokens: (mode==="fast") ? 1100 : 1400
  };

  const {out:visionOut, usedModel:usedVision} = await callVisionModelWithFallback(visionModels, visionPayload);
  const vMsg = visionOut?.choices?.[0]?.message?.content || "";
  job.rawVision = vMsg;

  let visionJson = null;
  const vJsonStr = extractJsonObject(vMsg) || vMsg;
  visionJson = safeJsonParse(vJsonStr);

  // è§†è§‰JSONè§£æå¤±è´¥ï¼šç”¨ä¿®å¤å™¨å…œåº•ï¼Œå†æŠ½å‡ºå¿…è¦å­—æ®µ
  if(!visionJson){
    const repaired = await repairToTarget(vMsg, topic, rubricObj, textModels);
    visionJson = {
      ocr_text: repaired.ocr_text || "",
      annotations: repaired.annotations || [],
      picture_desc: repaired.picture_desc || ""
    };
  }

  // åŸå›¾å°ºå¯¸ï¼ˆç”¨äºå®šä½/ç”»æ¡†ï¼‰
  const img = new Image();
  img.src = job.essayDataUrl;
  await new Promise(res=>img.onload=res);
  const imgW = img.naturalWidth, imgH = img.naturalHeight;

  // æ–‡æœ¬ç²¾æ‰¹ï¼ˆæœ€ç»ˆç»“æ„ï¼‰
  const textPrompt = buildTextPrompt(topic, rubricObj, mode, visionJson);
  const textPayload = {
    model: textModels[0],
    messages: [
      {role:"system", content:"ä½ æ˜¯ä¸€ä½å°å­¦è¯­æ–‡ç‰¹çº§æ•™å¸ˆã€‚åªè¾“å‡ºä¸¥æ ¼åˆæ³•JSONå¯¹è±¡ï¼›ä¸è¦Markdownï¼›ä¸è¦è§£é‡Šï¼›ä¸è¦reasoning_contentã€‚"},
      {role:"user", content: textPrompt}
    ],
    temperature: 0.1,
    max_tokens: (mode==="fast") ? 1400 : (mode==="pro" ? 2300 : 1800),
    response_format: {type:"json_object"},
    thinking: {type:"disabled"},
    do_sample: false
  };

  const {out:textOut, usedModel:usedText} = await callTextModelWithFallback(textModels, textPayload);
  const tMsg = textOut?.choices?.[0]?.message?.content || "";
  job.rawText = tMsg;

  let finalObj = safeJsonParse(tMsg);
  if(!finalObj){
    const j = extractJsonObject(tMsg);
    finalObj = j ? safeJsonParse(j) : null;
  }

  if(!finalObj){
    finalObj = await repairToTarget(tMsg, topic, rubricObj, textModels);
  }

  finalObj = validateAndNormalizeFinal(finalObj, rubricObj);

  finalObj = await expandAnnotationsIfNeeded(finalObj, topic, rubricObj, mode, textModels);
  finalObj = validateAndNormalizeFinal(finalObj, rubricObj);

  finalObj.meta = finalObj.meta || {};
  finalObj.meta.topic = topic || "";
  finalObj.meta.mode = mode;
  finalObj.meta.vision_model = usedVision || "";
  finalObj.meta.text_model = usedText || "";
  finalObj.meta.created_at = now();
  finalObj.ocr_meta = {imgW, imgH};

  job.result = finalObj;
  job.endedAt = Date.now();
}

/** =========================
 *  10. å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œ
 *  ========================= */
async function runQueue(){
  const {concurrency} = getSettings();
  if(!STATE.apiKey){ alert("è¯·å…ˆè®¾ç½®API Key"); return; }
  if(STATE.jobs.length === 0){ alert("è¯·å…ˆæ‰¹é‡ä¸Šä¼ ä½œæ–‡å›¾ç‰‡"); return; }

  const pending = STATE.jobs.filter(j=>j.status==="queued" || j.status==="error");
  if(pending.length === 0){ alert("é˜Ÿåˆ—å·²å®Œæˆ"); return; }

  const workers = Array.from({length: concurrency}, async ()=>{
    while(true){
      const job = STATE.jobs.find(j=>j.status==="queued");
      if(!job) break;

      job.status = "running";
      job.err = null;
      renderAll();

      try{
        await analyzeJob(job);
        job.status = "done";
        STATE.done += 1;
      }catch(e){
        job.status = "error";
        job.err = job.err || (e?.message || "æœªçŸ¥é”™è¯¯");
      }finally{
        renderAll();
      }

      await sleep(120);
    }
  });

  await Promise.all(workers);
}

/** =========================
 *  11. æ¸²æŸ“ï¼šä¸»Tab + å­Tab
 *  ========================= */
function setKeyUI(){
  keyState.textContent = STATE.apiKey ? "Keyï¼šå·²è®¾ç½®" : "Keyï¼šæœªè®¾ç½®";
  keyState.style.borderColor = STATE.apiKey ? "rgba(16,185,129,.5)" : "rgba(251,113,133,.55)";
  keyState.style.color = STATE.apiKey ? "var(--good)" : "var(--bad)";
}
function setPromptUI(){
  promptState.textContent = STATE.promptImg ? "å·²è®¾ç½®" : "æœªè®¾ç½®";
}
function setQueueUI(){
  qState.textContent = STATE.jobs.length;
  doneState.textContent = STATE.done;
}

function switchMainTab(tab){
  STATE.mainTab = tab;
  document.querySelectorAll(".tabbar .tab").forEach(el=>{
    el.classList.toggle("active", el.dataset.tab===tab);
  });
  panelQueue.style.display = (tab==="queue") ? "block" : "none";
  panelResult.style.display = (tab==="result") ? "block" : "none";
  panelSettings.style.display = (tab==="settings") ? "block" : "none";
  panelExport.style.display = (tab==="export") ? "block" : "none";
}
function switchResultSubTab(tab){
  STATE.resultSubTab = tab;
  renderResultPanel();
}

function renderQueuePanel(){
  setQueueUI();

  const list = STATE.jobs.map((job, idx)=>{
    const st = job.status;
    const stClass = st==="running" ? "running" : (st==="done"?"done": (st==="error"?"err":""));
    const score = job.result?.total_score;
    const ms = (job.startedAt && job.endedAt) ? (job.endedAt - job.startedAt) : null;
    const selected = job.id === STATE.selectedJobId;

    return `
      <div class="card" style="${selected?'border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.08)':''}">
        <div class="row" style="justify-content:space-between">
          <div class="file" title="${escapeHtml(job.name)}">${idx+1}. ${escapeHtml(job.name)}</div>
          <div class="status ${stClass}">${st==="queued"?"æ’é˜Ÿ":st==="running"?"æ‰¹æ”¹ä¸­":st==="done"?"å®Œæˆ":"é”™è¯¯"}</div>
        </div>

        <div class="row" style="margin-top:8px; justify-content:space-between">
          <div class="kpi">åˆ†æ•°ï¼š<b>${(typeof score==="number") ? score : "-"}</b> ï½œ è€—æ—¶ï¼š<b>${ms? (ms/1000).toFixed(1)+"s" : "-"}</b></div>
          <div class="row">
            <button class="btn-ghost btn" onclick="selectJob('${job.id}')">æŸ¥çœ‹</button>
            ${st==="error" ? `<button class="btn-ghost btn" onclick="retryJob('${job.id}')">é‡è¯•</button>` : ""}
          </div>
        </div>

        ${job.err ? `<div class="hint" style="margin-top:8px; color:var(--bad)">âš  ${escapeHtml(job.err)}</div>` : ""}
      </div>
    `;
  }).join("");

  panelQueue.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">é˜Ÿåˆ—ç®¡ç†</div>
          <div class="hint" style="margin-top:6px">å»ºè®®ï¼šä¸Šä¼ åå…ˆç‚¹â€œå¼€å§‹æ‰¹æ”¹â€ã€‚å®Œæˆåç‚¹â€œç»“æœâ€æŸ¥çœ‹æ›´å¤§çš„åˆ†åŒºé¡µé¢ã€‚</div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="clearQueue()">æ¸…ç©ºé˜Ÿåˆ—</button>
          <button class="btn-ghost btn" onclick="jumpToResult()">å»ç»“æœé¡µ</button>
        </div>
      </div>
    </div>
    ${list || `<div class="hint">è¿˜æ²¡æœ‰ä¸Šä¼ ä½œæ–‡ã€‚ç‚¹å‡»é¡¶éƒ¨â€œæ‰¹é‡ä¸Šä¼ ä½œæ–‡â€ã€‚</div>`}
  `;
}

function renderSettingsPanel(){
  const {topic, mode, rubricObj, visionModels, textModels, maxSide, concurrency} = getSettings();
  const rubricText = localStorage.getItem("zp_rubric_v112") || JSON.stringify(rubricObj, null, 2);

  panelSettings.innerHTML = `
    <div class="card">
      <div style="font-weight:900">è®¾ç½®ï¼ˆä¼šå½±å“æ‰¹æ”¹æ ‡å‡†ï¼‰</div>
      <div class="hint" style="margin-top:6px">ä½ å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹é¢˜ç›®ã€é˜…å·æ ‡å‡†ã€æ¨¡å‹å’Œå¹¶å‘æ•°ã€‚</div>
    </div>

    <div class="grid">
      <div class="field">
        <label>ä½œæ–‡é¢˜ç›®/ä»»åŠ¡<span class="hint">å¯é€‰</span></label>
        <input id="setTopic" type="text" value="${escapeHtml(topic)}" placeholder="ä¾‹ï¼šå›½åº†çš„è€å®¶ / çœ‹å›¾å†™è¯ï¼šæ‰¶èµ·æ‘”å€’çš„åŒå­¦..."/>
      </div>
      <div class="field">
        <label>æ¨¡å¼<span class="hint">é€Ÿåº¦/æ·±åº¦</span></label>
        <select id="setMode">
          <option value="fast" ${mode==="fast"?"selected":""}>æé€Ÿï¼ˆæ›´å¿«ï¼‰</option>
          <option value="std" ${mode==="std"?"selected":""}>æ ‡å‡†ï¼ˆæ¨èï¼‰</option>
          <option value="pro" ${mode==="pro"?"selected":""}>ç²¾æ‰¹ï¼ˆæ›´ç»†ï¼‰</option>
        </select>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="field">
        <label>è§†è§‰æ¨¡å‹ï¼ˆæå–OCR+å®šä½ï¼‰<span class="hint">è§†è§‰ä¸å¸¦response_format</span></label>
        <select id="setVision">
          ${["glm-4v-flash","glm-4v","glm-4.6v-flash"].map(m=>`<option value="${m}" ${(visionModels[0]===m)?"selected":""}>${m}</option>`).join("")}
        </select>
      </div>
      <div class="field">
        <label>æ–‡æœ¬æ¨¡å‹ï¼ˆç²¾æ‰¹/ä¿®å¤ï¼‰<span class="hint">json_objectå¼ºçº¦æŸ</span></label>
        <select id="setText">
          ${["glm-4.6","glm-4","glm-4-flash"].map(m=>`<option value="${m}" ${(textModels[0]===m)?"selected":""}>${m}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="field">
        <label>å¹¶å‘æ•°<span class="hint">1~6</span></label>
        <input id="setConc" type="number" min="1" max="6" value="${concurrency}"/>
        <div class="hint" style="margin-top:6px">å»ºè®® 2~3ï¼ˆè¿‡é«˜å¯èƒ½é™æµ/æ›´æ…¢ï¼‰</div>
      </div>
      <div class="field">
        <label>å‹ç¼©å°ºå¯¸<span class="hint">è¶Šå°è¶Šå¿«</span></label>
        <select id="setMax">
          ${[960,1100,1400].map(v=>`<option value="${v}" ${(maxSide===v)?"selected":""}>${v}</option>`).join("")}
        </select>
        <div class="hint" style="margin-top:6px">ä½œæ–‡å¤ªç³Šå¯é€‰ 1400ï¼›ä¸€èˆ¬ 1100 è¶³å¤Ÿ</div>
      </div>
    </div>

    <div class="field" style="margin-top:10px">
      <label>é˜…å·æ ‡å‡†ï¼ˆJSONï¼Œå¯æ”¹ï¼‰<span class="hint">å†³å®šå››ç»´æ»¡åˆ†ä¸ç‚¹è¯„å€¾å‘</span></label>
      <textarea id="setRubric">${escapeHtml(rubricText)}</textarea>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button class="btn-ghost btn" onclick="resetRubric()">æ¢å¤é»˜è®¤é‡è¡¨</button>
        <button class="btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
      <div class="hint" style="margin-top:8px">æ³¨æ„ï¼šé‡è¡¨å†™é”™ JSON ä¼šè‡ªåŠ¨ç”¨é»˜è®¤é‡è¡¨ç»§ç»­è·‘ã€‚</div>
    </div>
  `;
}

function renderResultPanel(){
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);

  if(!job){
    panelResult.innerHTML = `
      <div class="card">
        <div style="font-weight:900">ç»“æœæŸ¥çœ‹</div>
        <div class="hint" style="margin-top:6px">è¿˜æ²¡æœ‰é€‰æ‹©ä½œæ–‡ã€‚å»â€œé˜Ÿåˆ—â€ç‚¹ä¸€ç¯‡â€œæŸ¥çœ‹â€ã€‚</div>
      </div>
    `;
    return;
  }

  if(job.status !== "done" || !job.result){
    panelResult.innerHTML = `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">${escapeHtml(job.name)}</div>
            <div class="hint" style="margin-top:6px">çŠ¶æ€ï¼š${escapeHtml(job.status)}</div>
          </div>
          <div class="row">
            <button class="btn-ghost btn" onclick="switchMainTab('queue')">è¿”å›é˜Ÿåˆ—</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="hint">${job.err ? "âš  "+escapeHtml(job.err) : "å°šæœªå®Œæˆæ‰¹æ”¹ã€‚"}</div>
      </div>
    `;
    return;
  }

  const r = job.result;
  const rub = r.rubric || {};
  const dims = [
    ["å†…å®¹","content"],
    ["ç»“æ„","structure"],
    ["è¯­è¨€","language"],
    ["å·é¢","neatness"]
  ];

  const sub = STATE.resultSubTab;
  const subTabs = [
    ["overview","æ€»è§ˆ"],
    ["annotations","æ‰¹æ³¨"],
    ["model","èŒƒæ–‡"],
    ["exercises","ç»ƒä¹ "],
    ["ocr","OCR"],
    ["raw","åŸå§‹"]
  ];

  const rubricHtml = `
    <div class="rubric">
      ${dims.map(([label,key])=>{
        const obj = rub[key] || {score:0,max:1,comment:""};
        const pct = obj.max ? Math.max(0, Math.min(100, (obj.score/obj.max)*100)) : 0;
        return `
          <div class="rubItem">
            <div class="rubHead"><span>${label}</span><span style="color:var(--accent)">${obj.score}/${obj.max}</span></div>
            <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
            <div class="rubCmt">${escapeHtml(obj.comment||"")}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  const comment = r.teacher_comment || "";
  const rewrite = r.rewrite || {};
  const improvements = r.improvements || {};
  const modelEssay = r.model_essay || {};
  const exercises = Array.isArray(r.exercises) ? r.exercises : [];
  const annos = Array.isArray(r.annotations) ? r.annotations : [];

  const annoList = annos.map((a,i)=>`
    <div class="anno" onclick="focusAnno(${i})" data-anno="${i}">
      <div class="badge ${a.type==='good'?'good':'err'}">${a.type==='good'?'äº®ç‚¹':'çº é”™'}</div>
      <div style="flex:1">
        <div>
          <span class="${a.type==='error'?'del':''}">${escapeHtml(a.text||"")}</span>
          ${a.fix ? `<span class="fix">âœ ${escapeHtml(a.fix)}</span>` : ""}
        </div>
        <div class="reason">${escapeHtml(a.reason||"")}</div>
      </div>
    </div>
  `).join("");

  const improvementsHtml = (improvements && typeof improvements==="object") ? `
    <div class="sectionTitle">ğŸ“Œ æ”¹è¿›å»ºè®®</div>
    ${Object.keys(improvements).map(k=>{
      const arr = Array.isArray(improvements[k]) ? improvements[k] : [];
      if(arr.length===0) return "";
      return `
        <div class="hint" style="margin:8px 0 6px"><b style="color:var(--text)">${escapeHtml(k)}</b></div>
        <div class="hint" style="line-height:1.55">
          ${arr.map(x=>`â€¢ ${escapeHtml(x)}`).join("<br/>")}
        </div>
      `;
    }).join("")}
  ` : "";

  const overview = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">${escapeHtml(job.name)}</div>
          <div class="hint" style="margin-top:6px">
            æ¨¡å‹ï¼š${escapeHtml(r.meta?.vision_model||"-")} / ${escapeHtml(r.meta?.text_model||"-")} ï½œ ${escapeHtml(r.meta?.created_at||"")}
          </div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="printReportCurrent()">ğŸ–¨ æ‰“å°/PDF</button>
          <button class="btn-ghost btn" onclick="exportWordCurrent()">ğŸ“ Word(.doc)</button>
          <button class="btn-ghost btn" onclick="exportHtmlCurrent()">ğŸ“„ æŠ¥å‘ŠHTML</button>
        </div>
      </div>

      <div class="row" style="gap:14px; align-items:flex-end; margin-top:12px">
        <div class="scoreBig">${r.total_score ?? "-"}</div>
        <div class="hint">æ€»è¯„åˆ†ï¼ˆè‡ªåŠ¨æ ¡éªŒ=å››é¡¹ä¹‹å’Œï¼‰</div>
      </div>

      ${rubricHtml}

      <div class="sectionTitle">ğŸ‘©â€ğŸ« åå¸ˆç‚¹è¯„</div>
      <div class="box">${escapeHtml(comment)}</div>

      ${(rewrite?.improved) ? `
        <div class="sectionTitle">âœ¨ å‡æ ¼æ¶¦è‰²</div>
        <div class="box">
          <div style="opacity:.75">åŸå¥ï¼š${escapeHtml(rewrite.original||"")}</div>
          <div style="margin-top:6px; color:var(--primary); font-weight:900">å‡æ ¼ï¼š${escapeHtml(rewrite.improved||"")}</div>
          <small>æŠ€å·§ï¼š${escapeHtml(rewrite.technique||"")}</small>
        </div>
      ` : ""}

      ${improvementsHtml}
    </div>
  `;

  const model = `
    <div class="card">
      <div style="font-weight:900">æ”¹è¿›èŒƒæ–‡</div>
      <div class="divider"></div>
      ${modelEssay?.text ? `
        <div class="hint" style="margin-bottom:8px"><b style="color:var(--text)">${escapeHtml(modelEssay.title||"èŒƒæ–‡")}</b></div>
        <div class="box">${escapeHtml(modelEssay.text||"")}</div>
        ${Array.isArray(modelEssay.highlights) && modelEssay.highlights.length ? `
          <div class="hint" style="margin-top:10px">äº®ç‚¹ï¼š${modelEssay.highlights.map(x=>`ã€${escapeHtml(x)}ã€‘`).join(" ")}</div>
        ` : ""}
      ` : `<div class="hint">æœ¬æ¬¡è¾“å‡ºæœªåŒ…å«èŒƒæ–‡ï¼ˆå¯èƒ½æ˜¯æé€Ÿæ¨¡å¼æˆ–è¢«æˆªæ–­ï¼‰ã€‚</div>`}
    </div>
  `;

  const ex = `
    <div class="card">
      <div style="font-weight:900">ç»ƒä¸€ç»ƒï¼ˆ2é¢˜ï¼‰</div>
      <div class="divider"></div>
      ${exercises.length ? exercises.slice(0,2).map((e,idx)=>`
        <div class="hint" style="margin:8px 0 6px"><b style="color:var(--text)">é¢˜${idx+1}ï¼š</b>${escapeHtml(e.q||"")}</div>
        <div class="hint">ç­”æ¡ˆï¼š${escapeHtml(e.answer||"")} <span class="pill" style="margin-left:8px">${escapeHtml(e.skill||"")}</span></div>
        <div class="divider"></div>
      `).join("") : `<div class="hint">æœ¬æ¬¡è¾“å‡ºæœªåŒ…å«ç»ƒä¹ é¢˜ï¼ˆå¯èƒ½æ˜¯æé€Ÿæ¨¡å¼æˆ–è¢«æˆªæ–­ï¼‰ã€‚</div>`}
    </div>
  `;

  const ocr = `
    <div class="card">
      <div style="font-weight:900">OCR åŸæ–‡</div>
      <div class="divider"></div>
      <div class="hint" style="white-space:pre-wrap; line-height:1.6">${escapeHtml(r.ocr_text||"")}</div>
    </div>
  `;

  const raw = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900">åŸå§‹è¾“å‡ºï¼ˆä¾¿äºæ’é”™ï¼‰</div>
        <div class="row">
          <button class="btn-ghost btn" onclick="openDebugWithRaw('vision')">è§†è§‰åŸå§‹</button>
          <button class="btn-ghost btn" onclick="openDebugWithRaw('text')">æ–‡æœ¬åŸå§‹</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰“å¼€è°ƒè¯•é¢æ¿æŸ¥çœ‹ã€‚</div>
    </div>
  `;

  const annotations = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">æ‰¹æ³¨ï¼ˆç‚¹å‡»å®šä½ï¼‰</div>
          <div class="hint" style="margin-top:6px">å·¦ä¾§å›¾ç‰‡åŒºå¯æ‹–æ‹½/æ»šè½®ç¼©æ”¾ï¼›ç‚¹æ‰¹æ³¨ä¼šè‡ªåŠ¨å®šä½ã€‚</div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="drawBoxesForCurrent()">é‡ç”»æ¡†</button>
        </div>
      </div>
      <div class="divider"></div>
      ${annoList || `<div class="hint">æ²¡æœ‰æ‰¹æ³¨</div>`}
    </div>
  `;

  let body = overview;
  if(sub==="annotations") body = annotations;
  if(sub==="model") body = model;
  if(sub==="exercises") body = ex;
  if(sub==="ocr") body = ocr;
  if(sub==="raw") body = raw;

  panelResult.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">ç»“æœæŸ¥çœ‹ï¼ˆæ›´å¤§è§†å›¾ï¼‰</div>
          <div class="hint" style="margin-top:6px">ç”¨å­é€‰é¡¹å¡åˆ‡æ¢ï¼šæ€»è§ˆ/æ‰¹æ³¨/èŒƒæ–‡/ç»ƒä¹ /OCR/åŸå§‹ã€‚</div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="switchMainTab('queue')">è¿”å›é˜Ÿåˆ—</button>
        </div>
      </div>

      <div class="subtabs">
        ${subTabs.map(([k,label])=>`
          <div class="subtab ${k===STATE.resultSubTab?'active':''}" onclick="switchResultSubTab('${k}')">${label}</div>
        `).join("")}
      </div>
    </div>

    ${body}
  `;
}

function renderExportPanel(){
  panelExport.innerHTML = `
    <div class="card">
      <div style="font-weight:900">å¯¼å‡ºï¼ˆç¦»çº¿å¯ç”¨ï¼‰</div>
      <div class="hint" style="margin-top:6px">
        PDF é‡‡ç”¨â€œæ‰“å°â†’ä¿å­˜ä¸ºPDFâ€çš„æ–¹å¼ï¼ˆæœ€ç¨³å®šä¸”ä¸ä¾èµ–å¤–éƒ¨åº“ï¼‰ã€‚
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">å¯¼å‡ºå½“å‰é€‰ä¸­ä½œæ–‡</div>
          <div class="hint" style="margin-top:6px">å…ˆåˆ°â€œç»“æœâ€é¡µé€‰ä¸­ä¸€ç¯‡ä½œæ–‡ã€‚</div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="printReportCurrent()">ğŸ–¨ æ‰“å°/PDF</button>
          <button class="btn-ghost btn" onclick="exportWordCurrent()">ğŸ“ Word(.doc)</button>
          <button class="btn-ghost btn" onclick="exportHtmlCurrent()">ğŸ“„ æŠ¥å‘ŠHTML</button>
          <button class="btn-ghost btn" onclick="exportJsonAll()">â¬‡ å…¨éƒ¨JSON</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">å¯¼å‡ºå…¨éƒ¨åˆå¹¶æŠ¥å‘Š</div>
          <div class="hint" style="margin-top:6px">æŠŠæ‰€æœ‰å·²å®Œæˆä½œæ–‡åˆå¹¶åˆ°ä¸€ä¸ªHTMLä¸­ï¼Œä¾¿äºç»Ÿä¸€æ‰“å°æˆPDFã€‚</div>
        </div>
        <div class="row">
          <button class="btn-ghost btn" onclick="exportAllMergedHtml()">ğŸ“¦ åˆå¹¶æŠ¥å‘ŠHTML</button>
          <button class="btn-ghost btn" onclick="printAllMerged()">ğŸ–¨ åˆå¹¶æ‰“å°/PDF</button>
        </div>
      </div>
    </div>
  `;
}

function renderAll(){
  setKeyUI();
  setPromptUI();
  setQueueUI();

  renderQueuePanel();
  renderSettingsPanel();
  renderExportPanel();
  renderResultPanel();

  // ä¸»Tabæ˜¾ç¤º
  switchMainTab(STATE.mainTab);
}

/** =========================
 *  12. é€‰æ‹©/åˆ‡æ¢ä½œæ–‡
 *  ========================= */
window.selectJob = async (id)=>{
  STATE.selectedJobId = id;
  // è‡ªåŠ¨è·³åˆ°ç»“æœé¡µ
  switchMainTab("result");

  const job = STATE.jobs.find(j=>j.id===id);
  if(job?.essayDataUrl){
    essayImg.src = job.essayDataUrl;
    await new Promise(res=>essayImg.onload=res);
    empty.style.display = "none";
    wrapper.style.display = "block";
    const imgW = essayImg.naturalWidth, imgH = essayImg.naturalHeight;
    initCanvasForImage(imgW, imgH);
    if(job.result?.annotations) drawBoxes(job.result.annotations, imgW, imgH);
    else octx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  }
  renderAll();
};

window.retryJob = (id)=>{
  const job = STATE.jobs.find(j=>j.id===id);
  if(!job) return;
  job.status = "queued";
  job.err = null;
  job.result = null;
  renderAll();
};

window.focusAnno = (idx)=>{
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);
  if(!job?.result?.annotations) return;
  document.querySelectorAll(`[data-anno]`).forEach((el,i)=>{
    el.classList.toggle("active", i===idx);
  });
  const a = job.result.annotations[idx];
  if(a?.pos) showFocus(a.pos);
};

function selectByOffset(offset){
  if(STATE.jobs.length===0) return;
  const idx = STATE.jobs.findIndex(j=>j.id===STATE.selectedJobId);
  const next = (idx===-1) ? 0 : Math.max(0, Math.min(STATE.jobs.length-1, idx+offset));
  selectJob(STATE.jobs[next].id);
}

function jumpToResult(){
  switchMainTab("result");
  renderAll();
}

function clearQueue(){
  if(!confirm("ç¡®è®¤æ¸…ç©ºé˜Ÿåˆ—ï¼Ÿ")) return;
  STATE.jobs = [];
  STATE.selectedJobId = null;
  STATE.done = 0;
  empty.style.display = "block";
  octx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  renderAll();
}

function drawBoxesForCurrent(){
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);
  if(!job?.result?.annotations) return;
  drawBoxes(job.result.annotations, essayImg.naturalWidth, essayImg.naturalHeight);
}

/** =========================
 *  13. å¯¼å‡ºï¼šæŠ¥å‘Š HTML / Word / æ‰“å°PDF
 *  ========================= */
function nl2brHtml(s){
  return escapeHtml(s||"").replace(/\n/g,"<br/>");
}

function buildReportHTML(job){
  const r = job.result || {};
  const rub = r.rubric || {};
  const annos = Array.isArray(r.annotations)?r.annotations:[];
  const imp = r.improvements || {};
  const rewrite = r.rewrite || {};
  const modelEssay = r.model_essay || {};
  const exercises = Array.isArray(r.exercises)?r.exercises:[];

  const dimRow = (name, key)=>`
    <tr>
      <td style="padding:6px 8px; border:1px solid #e6e6e6; font-weight:700">${name}</td>
      <td style="padding:6px 8px; border:1px solid #e6e6e6">${rub[key]?.score ?? 0}/${rub[key]?.max ?? ""}</td>
      <td style="padding:6px 8px; border:1px solid #e6e6e6">${escapeHtml(rub[key]?.comment||"")}</td>
    </tr>
  `;

  const impHtml = (imp && typeof imp==="object") ? Object.keys(imp).map(k=>{
    const arr = Array.isArray(imp[k])?imp[k]:[];
    if(!arr.length) return "";
    return `<h4 style="margin:10px 0 6px">${escapeHtml(k)}</h4><ul style="margin:0 0 8px 18px">${arr.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
  }).join("") : "";

  const annoHtml = annos.map(a=>`
    <li style="margin:6px 0">
      <b>${a.type==="good"?"äº®ç‚¹":"çº é”™"}ï¼š</b>
      <span>${escapeHtml(a.text||"")}</span>
      ${a.fix?` <span style="color:#0a7a3b; font-weight:700">âœ ${escapeHtml(a.fix)}</span>`:""}
      <div style="color:#666; font-size:12px; margin-top:2px">ç†ç”±ï¼š${escapeHtml(a.reason||"")}</div>
    </li>
  `).join("");

  return `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>æ™ºæ‰¹æŠ¥å‘Š-${escapeHtml(job.name)}</title>
<style>
  body{font-family: Arial,"Microsoft YaHei",sans-serif; margin:28px; color:#111}
  h1{margin:0 0 8px}
  .meta{color:#555; font-size:12px; margin-bottom:14px}
  .score{font-size:42px; font-weight:900; color:#0077cc; margin:10px 0}
  .box{border-left:4px solid #0077cc; padding:10px 12px; background:#f6fbff; border-radius:8px}
  table{border-collapse:collapse; width:100%; margin:10px 0}
  .sec{margin-top:18px}
  .small{color:#666; font-size:12px}
  .hr{height:1px; background:#e6e6e6; margin:14px 0}
</style>
</head>
<body>
  <h1>æ™ºæ‰¹ä½œæ–‡æ‰¹æ”¹æŠ¥å‘Š</h1>
  <div class="meta">
    æ–‡ä»¶ï¼š${escapeHtml(job.name)}<br/>
    æ—¶é—´ï¼š${escapeHtml(r.meta?.created_at||"")}<br/>
    æ¨¡å¼ï¼š${escapeHtml(r.meta?.mode||"")} ï½œ é¢˜ç›®ï¼š${escapeHtml(r.meta?.topic||"ï¼ˆæœªæä¾›ï¼‰")}<br/>
    æ¨¡å‹ï¼š${escapeHtml(r.meta?.vision_model||"")} / ${escapeHtml(r.meta?.text_model||"")}
  </div>

  <div class="score">æ€»åˆ†ï¼š${r.total_score ?? "-"}</div>

  <div class="sec">
    <h2>è¯„åˆ†ç»†åˆ™</h2>
    <table>
      <tr>
        <th style="padding:6px 8px; border:1px solid #e6e6e6; background:#fafafa">ç»´åº¦</th>
        <th style="padding:6px 8px; border:1px solid #e6e6e6; background:#fafafa">å¾—åˆ†</th>
        <th style="padding:6px 8px; border:1px solid #e6e6e6; background:#fafafa">ç‚¹è¯„</th>
      </tr>
      ${dimRow("å†…å®¹","content")}
      ${dimRow("ç»“æ„","structure")}
      ${dimRow("è¯­è¨€","language")}
      ${dimRow("å·é¢","neatness")}
    </table>
  </div>

  <div class="sec">
    <h2>åå¸ˆç‚¹è¯„</h2>
    <div class="box">${nl2brHtml(r.teacher_comment||"")}</div>
  </div>

  ${rewrite?.improved ? `
  <div class="sec">
    <h2>å‡æ ¼æ¶¦è‰²</h2>
    <div class="box">
      <div><b>åŸå¥ï¼š</b>${nl2brHtml(rewrite.original||"")}</div>
      <div style="margin-top:6px"><b>å‡æ ¼ï¼š</b>${nl2brHtml(rewrite.improved||"")}</div>
      <div class="small" style="margin-top:6px"><b>æŠ€å·§ï¼š</b>${escapeHtml(rewrite.technique||"")}</div>
    </div>
  </div>
  ` : ""}

  ${impHtml ? `
  <div class="sec">
    <h2>æ”¹è¿›å»ºè®®</h2>
    ${impHtml}
  </div>` : ""}

  ${modelEssay?.text ? `
  <div class="sec">
    <h2>æ”¹è¿›èŒƒæ–‡</h2>
    <div class="box">
      <div><b>${escapeHtml(modelEssay.title||"èŒƒæ–‡")}</b></div>
      <div style="margin-top:8px">${nl2brHtml(modelEssay.text||"")}</div>
      ${Array.isArray(modelEssay.highlights)&&modelEssay.highlights.length ? `<div class="small" style="margin-top:8px">äº®ç‚¹ï¼š${modelEssay.highlights.map(x=>`ã€${escapeHtml(x)}ã€‘`).join(" ")}</div>`:""}
    </div>
  </div>
  ` : ""}

  ${exercises.length ? `
  <div class="sec">
    <h2>ç»ƒä¸€ç»ƒ</h2>
    ${exercises.slice(0,2).map((e,i)=>`
      <div class="box" style="margin-bottom:10px">
        <div><b>é¢˜${i+1}ï¼š</b>${escapeHtml(e.q||"")}</div>
        <div style="margin-top:6px"><b>ç­”æ¡ˆï¼š</b>${escapeHtml(e.answer||"")} <span class="small">ï¼ˆ${escapeHtml(e.skill||"")}ï¼‰</span></div>
      </div>
    `).join("")}
  </div>` : ""}

  <div class="sec">
    <h2>æ‰¹æ³¨åˆ—è¡¨</h2>
    <ul style="margin:0 0 0 18px">
      ${annoHtml || "<li>ï¼ˆæ— ï¼‰</li>"}
    </ul>
  </div>

  <div class="sec">
    <h2>OCR åŸæ–‡</h2>
    <div class="box">${nl2brHtml(r.ocr_text||"")}</div>
  </div>

  <div class="hr"></div>
  <div class="small">æç¤ºï¼šå¦‚éœ€PDFï¼Œæµè§ˆå™¨æ‰“å°é€‰æ‹©â€œä¿å­˜ä¸ºPDFâ€ã€‚</div>
</body>
</html>`;
}

function getCurrentJobDone(){
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);
  if(!job || job.status!=="done" || !job.result){
    alert("è¯·å…ˆåœ¨â€œç»“æœâ€é¡µé€‰æ‹©ä¸€ç¯‡å·²å®Œæˆçš„ä½œæ–‡ã€‚");
    return null;
  }
  return job;
}

function exportHtmlCurrent(){
  const job = getCurrentJobDone();
  if(!job) return;
  const html = buildReportHTML(job);
  downloadText(`æ™ºæ‰¹æŠ¥å‘Š_${job.name}.html`, html, "text/html");
}

function exportWordCurrent(){
  const job = getCurrentJobDone();
  if(!job) return;
  const html = buildReportHTML(job);

  // Word å…¼å®¹åŒ…è£…ï¼ˆ.docï¼‰
  const wordHtml = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><title>æ™ºæ‰¹æŠ¥å‘Š</title></head>
<body>${html.replace(/^[\s\S]*<body>/i,"").replace(/<\/body>[\s\S]*$/i,"")}</body>
</html>`;
  downloadText(`æ™ºæ‰¹æŠ¥å‘Š_${job.name}.doc`, wordHtml, "application/msword");
}

function printReportCurrent(){
  const job = getCurrentJobDone();
  if(!job) return;
  const html = buildReportHTML(job);
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=>w.print(), 400);
}

function exportJsonAll(){
  const rows = STATE.jobs.filter(j=>j.result).map(j=>({file:j.name, id:j.id, ...j.result}));
  if(!rows.length){ alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ"); return; }
  downloadText(`æ™ºæ‰¹ç»“æœ_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.json`, JSON.stringify(rows,null,2), "application/json");
}

function exportAllMergedHtml(){
  const jobs = STATE.jobs.filter(j=>j.result);
  if(!jobs.length){ alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ"); return; }
  const body = jobs.map(j=>buildReportHTML(j).replace(/^[\s\S]*<body>/i,"").replace(/<\/body>[\s\S]*$/i,"")).join("<div style='page-break-after:always'></div>");
  const html = `
<!doctype html><html><head><meta charset="utf-8"/><title>æ™ºæ‰¹åˆå¹¶æŠ¥å‘Š</title></head>
<body>${body}</body></html>`;
  downloadText(`æ™ºæ‰¹åˆå¹¶æŠ¥å‘Š_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.html`, html, "text/html");
}

function printAllMerged(){
  const jobs = STATE.jobs.filter(j=>j.result);
  if(!jobs.length){ alert("æ²¡æœ‰å¯æ‰“å°çš„ç»“æœ"); return; }
  const body = jobs.map(j=>buildReportHTML(j).replace(/^[\s\S]*<body>/i,"").replace(/<\/body>[\s\S]*$/i,"")).join("<div style='page-break-after:always'></div>");
  const html = `<!doctype html><html><head><meta charset="utf-8"/><title>æ™ºæ‰¹åˆå¹¶æŠ¥å‘Š</title></head><body>${body}</body></html>`;
  const w = window.open("", "_blank");
  w.document.open(); w.document.write(html); w.document.close();
  w.focus();
  setTimeout(()=>w.print(), 500);
}

/** =========================
 *  14. è°ƒè¯•
 *  ========================= */
function openDebugWithRaw(which){
  const job = STATE.jobs.find(j=>j.id===STATE.selectedJobId);
  if(!job) return;
  dbgPanel.style.display = "block";
  dbgReq.textContent = STATE.lastReq ? JSON.stringify(STATE.lastReq,null,2) : "(æš‚æ— )";
  dbgRes.textContent = which==="vision" ? (job.rawVision||"(ç©º)") : (job.rawText||"(ç©º)");
}

/** =========================
 *  15. è®¾ç½®ä¿å­˜
 *  ========================= */
function saveSettings(){
  const topic = $("setTopic").value.trim();
  const mode = $("setMode").value;
  const vision = $("setVision").value;
  const text = $("setText").value;
  const conc = $("setConc").value;
  const max = $("setMax").value;
  const rubricRaw = $("setRubric").value.trim();

  localStorage.setItem("zp_topic_v112", topic);
  localStorage.setItem("zp_mode_v112", mode);
  localStorage.setItem("zp_vision_model_v112", vision);
  localStorage.setItem("zp_text_model_v112", text);
  localStorage.setItem("zp_conc_v112", String(conc));
  localStorage.setItem("zp_imgmax_v112", String(max));

  if(rubricRaw){
    const parsed = safeJsonParse(rubricRaw);
    if(!parsed || !parsed.dims){
      alert("é˜…å·æ ‡å‡†JSONè§£æå¤±è´¥ï¼šå·²ä¿ç•™æ—§è®¾ç½®ï¼ˆæˆ–æ¢å¤é»˜è®¤ï¼‰ã€‚è¯·æ£€æŸ¥JSONæ ¼å¼ã€‚");
    }else{
      localStorage.setItem("zp_rubric_v112", JSON.stringify(parsed,null,2));
    }
  }
  alert("âœ… è®¾ç½®å·²ä¿å­˜");
  renderAll();
}

function resetRubric(){
  localStorage.setItem("zp_rubric_v112", JSON.stringify(DEFAULT_RUBRIC,null,2));
  renderAll();
}

/** =========================
 *  16. äº‹ä»¶ç»‘å®šï¼ˆé¡¶éƒ¨æŒ‰é’®ï¼‰
 *  ========================= */
document.querySelectorAll(".tabbar .tab").forEach(el=>{
  el.addEventListener("click", ()=>{
    switchMainTab(el.dataset.tab);
    renderAll();
  });
});

$("btnToggleLeft").onclick = ()=>{
  STATE.leftShown = !STATE.leftShown;
  leftPane.classList.toggle("hidden", !STATE.leftShown);
};

$("btnKey").onclick = ()=>{
  $("keyInput").value = STATE.apiKey || "";
  keyModal.style.display="flex";
};
$("btnKeyCancel").onclick = ()=> keyModal.style.display="none";
$("btnKeySave").onclick = ()=>{
  const k = $("keyInput").value.trim();
  if(!k){ alert("Keyä¸èƒ½ä¸ºç©º"); return; }
  STATE.apiKey = k;
  sessionStorage.setItem("zp_key_v112", k);
  setKeyUI();
  keyModal.style.display="none";
  renderAll();
};

$("btnPromptImg").onclick = ()=> promptFile.click();
promptFile.onchange = async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  STATE.promptImg = await fileToDataUrl(file);
  setPromptUI();
  alert("âœ… é¢˜å›¾å·²è®¾ç½®ï¼ˆå°†å½±å“å®¡é¢˜ä¸è¯„åˆ†ï¼‰");
  renderAll();
};

$("btnUpload").onclick = ()=> essayFiles.click();
essayFiles.onclick = ()=>{ essayFiles.value=""; };

// === æ ¸å¿ƒä¿®æ”¹ï¼šæ‰¹é‡ä¸Šä¼ å¹¶è‡ªåŠ¨æ‹¼å›¾ ===
essayFiles.onchange = async (e) => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;

  // 1. åˆ†ç»„é€»è¾‘ (1.1.jpg, 1.2.jpg)
  const groups = {};
  // æ­£åˆ™å«ä¹‰ï¼šåŒ¹é…å¼€å¤´æ•°å­—(ID) + åˆ†éš”ç¬¦ + æ•°å­—(é¡µç )
  const regex = /^([a-zA-Z0-9\u4e00-\u9fa5]+)([-_.]?)(\d+)\./; 

  for (const f of files) {
    const match = f.name.match(regex);
    let id = f.name; // é»˜è®¤ç”¨æ–‡ä»¶å
    let page = 1;

    if (match) {
      id = match[1]; // ä¾‹å¦‚ "1"
      page = parseInt(match[3]); // ä¾‹å¦‚ 1
    }
    
    if (!groups[id]) groups[id] = [];
    groups[id].push({ file: f, page: page, name: f.name });
  }

  // 2. æ’åºä¸å¤„ç†
  // è‡ªç„¶æ’åºID (1, 2, 10...)
  const sortedIds = Object.keys(groups).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
  let newCount = 0;

  for (const id of sortedIds) {
    const list = groups[id];
    // æŒ‰é¡µç æ’åº (1.1, 1.2)
    list.sort((a,b)=> a.page - b.page);

    // è¯»å–æ‰€æœ‰å›¾ç‰‡æ•°æ®
    const urls = await Promise.all(list.map(x => fileToDataUrl(x.file)));
    
    // å¦‚æœæœ‰å¤šé¡µï¼Œæ‹¼å›¾ï¼›å•é¡µç›´æ¥ç”¨
    const finalUrl = await stitchImages(urls);
    const displayName = list.length > 1 ? `${id} (å…±${list.length}é¡µ)` : list[0].name;

    STATE.jobs.push({
      id: uid(),
      name: displayName,
      essayDataUrl: finalUrl, // å­˜å…¥æ‹¼æ¥åçš„é•¿å›¾
      status: "queued",
      result: null,
      err: null,
      rawVision: "",
      rawText: "",
      startedAt: null,
      endedAt: null
    });
    newCount++;
  }

  empty.style.display = STATE.jobs.length ? "none" : "block";
  setQueueUI();

  if(!STATE.selectedJobId && STATE.jobs[0]){
    await selectJob(STATE.jobs[0].id);
  }
  
  // å…è®¸é‡å¤ä¸Šä¼ 
  essayFiles.value = ""; 
  renderAll();
  
  // æç¤º
  alert(`æˆåŠŸå¯¼å…¥ ${newCount} ä»½ä½œä¸šï¼ˆå·²è‡ªåŠ¨åˆå¹¶å¤šé¡µï¼‰`);
};

$("btnStart").onclick = ()=> runQueue();

$("btnDebug").onclick = ()=>{
  dbgPanel.style.display = (dbgPanel.style.display==="block") ? "none" : "block";
  dbgReq.textContent = STATE.lastReq ? JSON.stringify(STATE.lastReq,null,2) : "(æš‚æ— )";
  dbgRes.textContent = STATE.lastRes || "(æš‚æ— )";
};

$("btnSelectNext").onclick = ()=> selectByOffset(+1);
$("btnSelectPrev").onclick = ()=> selectByOffset(-1);

$("btnCloseDbg").onclick = ()=> dbgPanel.style.display="none";
$("btnCopyReq").onclick = ()=> copyToClipboard(dbgReq.textContent || "");
$("btnCopyRes").onclick = ()=> copyToClipboard(dbgRes.textContent || "");

/** =========================
 *  17. åˆå§‹åŒ–
 *  ========================= */
function init(){
  // åˆå§‹åŒ–é»˜è®¤é‡è¡¨ï¼ˆè‹¥æ²¡æœ‰ï¼‰
  if(!localStorage.getItem("zp_rubric_v112")){
    localStorage.setItem("zp_rubric_v112", JSON.stringify(DEFAULT_RUBRIC,null,2));
  }
  setKeyUI();
  setPromptUI();
  setQueueUI();

  // é»˜è®¤æ‰“å¼€é˜Ÿåˆ—é¡µ
  switchMainTab("queue");

  if(!STATE.apiKey){
    setTimeout(()=> keyModal.style.display="flex", 450);
  }
  renderAll();
}
init();
</script>
</body>
</html>